<div class="space-y-6">
  <!-- Info Box -->
  <div class="bg-brand-50/50 rounded-xl p-6 border border-brand-300/40">
    <h3 class="text-lg font-semibold text-cream-900 mb-2 font-display">
      Проверьте ваши добавки
    </h3>
    <p class="text-cream-700 font-body text-sm">
      Для успешной программы детоксикации вам понадобятся определённые добавки. Отметьте те, которые у вас уже есть, чтобы знать, что нужно заказать.
    </p>
  </div>

  <!-- Region Tabs -->
  <div class="border-b border-cream-300">
    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
      @for (region of regions; track region) {
        <button
          (click)="activeTab.set(region)"
          [class]="activeTab() === region
            ? 'border-brand-600 text-brand-700 font-semibold'
            : 'border-transparent text-cream-600 hover:text-cream-800 hover:border-cream-400'"
          class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm font-display transition-colors relative"
        >
          {{ getRegionLabel(region) }}
          @if (region === userRegion()) {
            <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-brand-100 text-brand-800">
              Ваш регион
            </span>
          }
        </button>
      }
    </nav>
  </div>

  <!-- Products Display -->
  <div class="space-y-8">
    <!-- Base Level Products -->
    @if (baseProducts().length > 0) {
      <div>
        <div class="flex items-center mb-4">
          <div class="flex-grow">
            <h4 class="text-lg font-semibold text-cream-900 font-display">
              Базовый уровень
            </h4>
            <p class="text-sm text-cream-600 font-body">Обязательные добавки для всех участников</p>
          </div>
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-brand-100 text-brand-800">
            Обязательно
          </span>
        </div>
        
        <div class="space-y-3">
          @for (product of baseProducts(); track product.id) {
            <div
              class="bg-white rounded-xl border border-cream-300 hover:border-brand-400 transition-all duration-200 overflow-hidden cursor-pointer"
              [class.ring-2]="isChecked(product.id)"
              [class.ring-brand-500]="isChecked(product.id)"
              [class.bg-brand-50/30]="isChecked(product.id)"
              (click)="toggleProduct(product.id)"
            >
              <div class="flex items-start p-4 gap-4">
                <!-- Checkbox -->
                <div class="flex-shrink-0 pt-1">
                  <div
                    [class]="isChecked(product.id)
                      ? 'bg-brand-600 border-brand-600'
                      : 'bg-white border-cream-400'"
                    class="w-6 h-6 border-2 rounded-md flex items-center justify-center transition-colors"
                  >
                    @if (isChecked(product.id)) {
                      <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path
                          fill-rule="evenodd"
                          d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                          clip-rule="evenodd"
                        ></path>
                      </svg>
                    }
                  </div>
                </div>

                <!-- Product Image -->
                <div class="flex-shrink-0">
                  <img
                    [src]="imageService.getProductImage(product.imageURL || '', { width: 80, height: 80, quality: 85 })"
                    [alt]="product.name"
                    class="w-20 h-20 object-contain rounded-lg bg-white"
                  />
                </div>

                <!-- Product Info -->
                <div class="flex-grow min-w-0">
                  <h5 class="text-base font-semibold text-cream-900 font-display mb-1">
                    {{ product.name }}
                  </h5>
                  <p class="text-sm text-cream-700 font-body mb-2 line-clamp-2">
                    {{ product.description }}
                  </p>
                  
                  <!-- Substitute Info -->
                  @if (getSubstituteInfo(product)) {
                    <div class="mt-2 p-2 bg-cream-50 rounded-lg border border-cream-300">
                      <p class="text-xs text-cream-700 font-body">
                        <span class="font-semibold">Альтернативы:</span> {{ getSubstituteInfo(product) }}
                      </p>
                    </div>
                  }

                  <!-- Dosage Info -->
                  @if (product.takes && product.takes.length > 0) {
                    <div class="mt-2 flex items-start gap-1.5">
                      <svg class="w-4 h-4 text-brand-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                      <p class="text-xs text-cream-600 font-body">
                        {{ product.takes[0].amount }}
                        @if (product.takes[0].notes) {
                          · {{ product.takes[0].notes }}
                        }
                      </p>
                    </div>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    }

    <!-- Advanced Level Products -->
    @if (advancedProducts().length > 0) {
      <div>
        <div class="flex items-center mb-4">
          <div class="flex-grow">
            <h4 class="text-lg font-semibold text-cream-900 font-display">
              Продвинутый уровень
            </h4>
            <p class="text-sm text-cream-600 font-body">Дополнительная поддержка для интенсивной детоксикации</p>
          </div>
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-cream-200 text-cream-800">
            Опционально
          </span>
        </div>
        
        <div class="space-y-3">
          @for (product of advancedProducts(); track product.id) {
            <div
              class="bg-white rounded-xl border border-cream-300 hover:border-brand-400 transition-all duration-200 overflow-hidden cursor-pointer"
              [class.ring-2]="isChecked(product.id)"
              [class.ring-brand-500]="isChecked(product.id)"
              [class.bg-brand-50/30]="isChecked(product.id)"
              (click)="toggleProduct(product.id)"
            >
              <div class="flex items-start p-4 gap-4">
                <!-- Checkbox -->
                <div class="flex-shrink-0 pt-1">
                  <div
                    [class]="isChecked(product.id)
                      ? 'bg-brand-600 border-brand-600'
                      : 'bg-white border-cream-400'"
                    class="w-6 h-6 border-2 rounded-md flex items-center justify-center transition-colors"
                  >
                    @if (isChecked(product.id)) {
                      <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path
                          fill-rule="evenodd"
                          d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                          clip-rule="evenodd"
                        ></path>
                      </svg>
                    }
                  </div>
                </div>

                <!-- Product Image -->
                <div class="flex-shrink-0">
                  <img
                    [src]="imageService.getProductImage(product.imageURL || '', { width: 80, height: 80, quality: 85 })"
                    [alt]="product.name"
                    class="w-20 h-20 object-contain rounded-lg bg-white"
                  />
                </div>

                <!-- Product Info -->
                <div class="flex-grow min-w-0">
                  <h5 class="text-base font-semibold text-cream-900 font-display mb-1">
                    {{ product.name }}
                  </h5>
                  <p class="text-sm text-cream-700 font-body mb-2 line-clamp-2">
                    {{ product.description }}
                  </p>

                  <!-- Substitute Info -->
                  @if (getSubstituteInfo(product)) {
                    <div class="mt-2 p-2 bg-cream-50 rounded-lg border border-cream-300">
                      <p class="text-xs text-cream-700 font-body">
                        <span class="font-semibold">Альтернативы:</span> {{ getSubstituteInfo(product) }}
                      </p>
                    </div>
                  }

                  <!-- Dosage Info -->
                  @if (product.takes && product.takes.length > 0) {
                    <div class="mt-2 flex items-start gap-1.5">
                      <svg class="w-4 h-4 text-brand-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                      <p class="text-xs text-cream-600 font-body">
                        {{ product.takes[0].amount }}
                        @if (product.takes[0].notes) {
                          · {{ product.takes[0].notes }}
                        }
                      </p>
                    </div>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    }
  </div>

  <!-- Summary Box -->
  <div class="bg-cream-50 rounded-xl p-5 border border-cream-300/50">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-semibold text-cream-900 font-display mb-1">
          Отмечено продуктов
        </p>
        <p class="text-xs text-cream-600 font-body">
          Вы можете продолжить, даже если ещё не всё заказано
        </p>
      </div>
      <div class="text-right">
        <p class="text-3xl font-bold text-brand-600">
          {{ checkedProducts().size }}
        </p>
        <p class="text-xs text-cream-600 font-body">
          из {{ regionProducts().length }}
        </p>
      </div>
    </div>
  </div>
</div>

